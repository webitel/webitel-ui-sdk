# Userinfo: Access Control

Модуль відповідає за зберігання та розрахунок прав доступу до дій / сторінок / обʼєктів.

## Словник

### Scope Class – Скоуп клас

Скоуп клас – деяка кількість обʼєктів, які покриваються спільним правом (цим самим Scope Class'ом) 

Enum'а, яка репрезентує: [Scope Class](https://github.com/webitel/webitel-ui-sdk/blob/f16e485410173fc4ed600cbd3e5c0b0bf2cf7577/src/modules/Userinfo/enums/ScopeClass/ScopeClass.ts)

### Сутність / обʼєкт

Обʼєкт певної сутності системи:

1. Користувачі
2. Регіони
3. Календарі
4. ...

Enum'а, яка репрезентує: [WtObject](https://github.com/webitel/webitel-ui-sdk/blob/f16e485410173fc4ed600cbd3e5c0b0bf2cf7577/src/enums/WtObject/WtObject.ts)

## Як назначаються Права доступу

Права доступу **сумуються** для **користувача** і **всіх його ролей**.

### Назначаються на користувача

* [Ліцензії](#ліцензії)

### Назначаються на роль

* [Global Role Permissions](#global-role-permissions)
* [Role Visual Access](#role-visual-access)
* [ObAC i RbAC](#obac--rbac) – але також можуть бути назначені і на користувача.

## Конфігурації, які впливають на наявність прав доступу

### Ліцензії

Мають найбільший вплив на функціонал: можна надати всі права користувачу та його ролі,
але без ліцензії функціонал не працюватиме.

Налаштовуються у Admin/Directory/License або у карточці користувача

*Наприклад*, 
якщо присвоїти користувачу роль, яка має глобальне право доступу на Read, а також ObAC права доступу на `cases`, але забрати у нього ліцензію `CUSTOMER_SERVICE` – то і до звернень у нього доступу не буде.

![](./_assets/license-users-preview.png)

### Global Role Permissions

Складаються з CRUD прав і інших, специфічних прав на конкретні дії.

Налаштовуються в Admin/Roles у 2й табі карточки ролі.

![](./_assets/role-permissions-tab-preview.png)

#### Global CRUD Permissions

Фактично, "глобальне" ObAC на всі Scope Class'и на конкретну дію.

#### Global Special Permissions

Всі крім попередніх. 
Регулюють, наприклад, право на прослуховування записів розмов, 
або на перегляд екрану оператора.

### ObAC / RbAC

Регулює права доступу до конкретних Scope Class'ів. 

![](./_assets/permissions-objects-list-preview.png)


![](./_assets/permissions-object-grantees-preview.png)

>[!IMPORTANT]
> Зверніть увагу! 
> 
> Один обʼєкт прав може давати доступ на декілька сутностей системи. Тобто, наприклад
> обʼєкт `dictionaries` дає право на половину розділів в `Admin/Lookups`.
> Конкретно зі списком маппінгів можна ознайомитись [тут](https://github.com/webitel/webitel-ui-sdk/blob/f16e485410173fc4ed600cbd3e5c0b0bf2cf7577/src/modules/Userinfo/mappings/mappings.ts#L24).


>[!WARNING]
> Зверніть увагу! 
> 
> **Якщо ObAC викнений, то він не працюватиме**. Тобто, "дозволено все".

### Role Applications (Visual) Access

Регулюють суто візуальний доступ до секцій на рівні навігації. 
Ідея в тому, щоб простіше і гранулярніше
давати доступ до певних роутів.

Тобто, наприклад:
1. Можна дати користувачу ObAC доступ до `users`..
2. .. але не дати візуальний доступ до самого розділу `Admin/directory/users`

Тоді користувач зможе бачити список юзерів у селектах, але при цьому не матиме змоги перейти
на сам розділ з табличкою.

![](./_assets/role-visual-access-preview.png)

Візуальний доступ ніяк не впливає на бекенд, і ніяк не регулюється. Навіть схема даних.
Це – суто фронтенд фіча.

## Як (в кінцевому вигляді) розраховуються права

Права надаються на:
1. Обʼєкти – як частини Scope Class'ів (розраховує бекенд)
2. Видимість розділів (розраховує фронтенд)

### Розрахунок прав для Обʼєкта

>[!WARNING]
> **Це все розраховує бекенд!**
> 
> **Ми НІ В ЯКОМУ РАЗІ не маємо це розраховувати самостійно**. Бекенд нам вертає на API `/userinfo` поле `scope`, 
> у якому вертаються скоуп класи, до яких точно є доступ згідно розрахунків нижче.
>
> Описане нижче – для розуміння, як це розраховується

За умови, що ObAC включений

`has License` && (`has Global Permisson` || `has ObAC`) – тут ми отримуємо доступ до Scope Class.

А Scope Class вже надає доступ до Обʼєкта.

### Розрахунок прав до видимості розділу

>[!IMPORTANT]
> На відміну від попереднього, це вже розраховуємо ми у `userinfoStore`.

`has Object Class Scope Access` && `has Application Visibility` && `hasSectionVisibility` 

## Де перевіряються права

На фронтенді

### TLDR

#### Є 3 "шматки" перевірки прав

1. **Перевірка на етапі роутингу**: глобальний router guard, 
який реєструється при ініціалізації `userinfoStore`.

В основному, виконує функцію "пустити"/"не пустити" до певної сторінки.

2. **Перевірка на CRUD в середині компонентів**: `useUserAccessControl` composable,
який використовується в компонентах для перевірки **CRUD** (!) прав до конкретного обʼєкта.

3. **Специфічні перевірки на глобальні права або ліцензії**:
`userinfoStore` зі своїми геттерами для таких кейсів.

#### А також необхідні enum'и

* `WtObject` – обʼєкт / сутність системи, до якої можна перевіряти права.
* `SpecialGlobalAction` – специфічна глобальна дія, до якої можна перевіряти права (наприклад, на записи розмов).
* `WebitelLicense` – ліцензія.
* `WtApplication`.
* `UiSection`: `AdminSections`, `AuditorSections`, `SupervisorSections`, `CrmSections`.

## Для "розробників" модуля
